# Simulation of diffusion of a news on a lattice
                                                                                          
                                                                                        
# creation: -March 09, 2020
# name: lattice_diffusion_v1.R
                                                                                                                                                                                                                                    
# Idea in breif:
# we simulate a diffusion of a message through a network based on a 
# lattice. The lattice is just the sPATIAL STRUCTURE for which the network is build.
# This network could                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           be based in a ER o small network type.
# We want to study the diffusion of a message on these kind of network
# and see the possibility of percolation. 



# BASIC PROCEDURE (generate a small world net) in a grid:
# 1. generate a spatial ER network (ver simulation_v1.R)
# 2. select a random node in the spatial ER net.
# 3. simulate a message transfer to neighborhoods with probability p
# 4. analyze number of nodes that receives and transfer message at each time with different values of p.
#   correlationate the results with geografic distances among nodes.
# 5. Aditional: count number of cliques and balances and unbalanced triangles.



rm(list = ls())
library(ggplot2)
library(gdata)
library(igraph)
source("lattice_creation_function.R")
source("get_powerLaw_prob_function.R")
source("genSpatialDistribution_function.R")
source("genSpatialNet_function.R")
vector.is.empty <- function(x) return(length(x) ==0 ) # para detectar si un vector esta vacio

# PARAMETROS
# Nota: con m=size_lattice=30 y N=100, el ratio (m^2)/N = 9
# Nota: con m=size_lattice=95 y N=1000, se demora mucho
# Nota: con m=size_lattice=67 y N=500, se demora mucho
# Nota: con m=size_lattice=42 y N=200, ya no demora tanto
size_lattice = 42 # numero de vertices por lado del lattice 
N = 200 # number of humans
a = 1.1 # clustering exponent. the Higher the exponent, more difficult the conection at higher distances


# # # # # # # # # # # # # # # # # # 1. Generate a spatial ER network (ver simulation_v1.R)
# m es el lado del cuadrado.
# obs: cuando N/m^2 es aprox igual al 10%, la red comienza a conectarse mas.
# n/m^2 es la probabilidad que un hueco del lattice sea ocupado por un humanoide.

df <- lattice_creation(m = size_lattice, number_of_humans = N)
C <- genStatialDistribution(df = df, alpha = a)
g <- genSpatialNet(df = df, number_of_humans = N, C = C, alpha = a, method="normal")

par(mar = c(1.5, 1.5, 1.5, 1.5))
plot(g,
     edge.arrow.size =.3,
     edge.curved = 0,
     vertex.color = "yellow",
     vertex.frame.color="#555555",
     #vertex.label = V(mst_g)$name,
     vertex.label.color = "black",
     vertex.label.cex=.6,
     vertex.size = 7)
title("Spatial ER Social Net", cex.main=0.5, col.main="black")

# aparte:
# como graficar la red social espacial en el plano cartesiano acorde a las coordenadas
par(mar = c(1.5, 1.5, 1.5, 1.5))
plot(g, layout=as.matrix(df[,c(2,3)] ),
     edge.arrow.size =.3,
     edge.curved = 0,
     vertex.color = "yellow",
     vertex.frame.color="#555555",
     #vertex.label = V(mst_g)$name,
     vertex.label.color = "black",
     vertex.label.cex=.6,
     vertex.size = 7)
title("Spatial ER Social Net on the grid", cex.main=0.5, col.main="black")

# get the distances between each node of the connected human in spatial social net
# Note: dataframe df mus be loaded
edgel <- as_edgelist(g, names = TRUE)
distan <- numeric(length = nrow(edgel))
for (i in 1:length(distan) ) {
  con <- edgel[i,]
  con <- as.numeric(con)
  id_node1 <- which(df["human"] == con[1])
  id_node2 <- which(df["human"] == con[2])
  v1 <- as.matrix(df[id_node1, c(2,3)])
  v2 <- as.matrix(df[id_node2, c(2,3)])
  v = v2-v1
  d = sqrt(v%*%t(v))
  distan[i] <- d
}
edgel <- as.data.frame(edgel)
edgel$distances <- distan
hist(log(edgel$distances),30)
# # # # # # # # # # # # # # # # # # 1. Generate a spatial ER network (ver simulation_v1.R)

# # # # # # # # # # # # # # # # # #  2. select a random node in the spatial ER net.
human_node_start <- sample(V(g), 1)
# # # # # # # # # # # # # # # # # #  2. select a random node in the spatial ER net.

# # # # # # # # # # # # # # # # # # 3. simulate a message transfer to neighborhoods with probability p
# proceso de contagio (o diifusion)
# 1. para cada uno de los nodos contaminados del periodo anterior (con s=1), identificar los nodos adyacentes de 
  #nota: Si uno de los nodos adyacentes ya esta conaminado (s=1), no considerarlo
# 2. contaminar los nodos adyacentes con probabilidad p.
# 3. identificar nodos adyacentes contaminados y guardarlos en el set "contaminados"
# 4. repetir hasta un cierto numero de veces igual a "periods"

# Inputs:
# g: objeto igraph social net
# p = probabilidad de contagio
# periods: numero de periodos a simular
# n_sims <- numero de simulaciones
# outputs: 
# number_of_contamined: dataframe con dos columnas: t y numero de contaminados
# contamined_nodes: lista con los nodos contaminados en cada t
msg_transfer_sim <- function(g, p, periods, n_sims) {
  # aqui se guardan todas las simulaciones
  Sims <- matrix(NA, ncol=n_sims+1, nrow = periods)
  
  for (s in 1:n_sims ) {
    V(g)$contamined <- 0
    contamined <- vector(length=0) # nodos contaminados en s=1
    tested <- vector(length=0) # nodos por los que se han pasado
    contamined <- c(contamined, human_node_start)
    # registraremos los nodos que se van contagiendo:
    contamined_nodes <- vector("list", length = periods)
    number_of_contamined <- matrix(NA, ncol=2, nrow=periods ) # registramos numero de nodos contaminados en cada tiempo
    number_of_contamined <- as.data.frame(number_of_contamined)
    colnames(number_of_contamined) <- c("time", "infected")
    V(g)$contamined[human_node_start] <- 1
    tested <- c(tested, human_node_start)
    nodes_to_test <- human_node_start
    for (t in 1:periods) {
      #vemos los nodos adyacentes
      ady_nodes <- adjacent_vertices(g, nodes_to_test)  
      ady_nodes <- as.numeric(unlist(ady_nodes))
      # vemos si algunos de los nodos adyacentes ya estan contaminados, en ese caso, los sacamos 
      id_drop <- which(V(g)$contamined[ady_nodes] == 1)
      if ( !vector.is.empty(id_drop) ) {
        ady_nodes <- ady_nodes[-id_drop]
      }
      # vemos si algunos de los nodos adyacentes ya habian sido testeados, en ese caso, los sacamos 
      id_drop <- which( ady_nodes %in% tested )
      if ( !vector.is.empty(id_drop) ) {
        ady_nodes <- ady_nodes[-id_drop]
      }
      # En caso que hayan sido testeados todos los nodos, debemos parar
      if ( vector.is.empty(ady_nodes)  ) {
        print(paste("All the nodes have been tested! Process stopped at it:  ", t))
        break
      }
      
      # contaminacion de nodos
      sel <- (runif(length(ady_nodes)) > 0.5)
      sel <- 1*sel
      id <- which(sel == 1)
      recently_contamined <- ady_nodes[id]
      # En el caso que ningun nodo se contamine, el proceso se detiene!!
      if ( vector.is.empty(recently_contamined)  ) {
        print(paste("There were no more transfers! Process stopped at it:  ", t))
        break
      }
      contamined <- c(contamined, recently_contamined) # se registran los nuevos nodos contaminados
      contamined_nodes[[t]] <- recently_contamined
      
      # para el siguiente ciclo.
      tested <- c(tested, ady_nodes) # se registran los nodos que ya han sido testeados
      nodes_to_test <- recently_contamined
      V(g)$contamined[recently_contamined] <- 1
      number_of_contamined[t, ] <- c(t, length(recently_contamined))
    }
    number_of_contamined$acum <- cumsum(number_of_contamined$infected)
    Sims[, s] <- number_of_contamined$acum
  }
  
  return(Sims)
}
# ejemplo
Sms <- msg_transfer_sim(g = g, p = 0.5, periods = 50, n_sims=100)
Sms[,n_sims+1] <- c(1:periods)

# multiple plots of the simulation:
# Seteo del plot
plot(Sms[, n_sims+1], Sms[,1], type="l",
     xlab="Time", ylab="Acum(t)", ylim=c(0, 200), xlim=c(0, 30) )
colors = rainbow(100)

# add lines
for ( i in 1:100) {
  lines(Sms[, n_sims+1], Sms[,i], type="l", col=colors[i])
}



# Version a mano de msg_transfer_sim  (no funcion)
p <- 0.5 # probabilidad de contagio o traspaso de mensaje
periods = 50
V(g)$contamined <- 0
contamined <- vector(length=0) # nodos contaminados en s=1
tested <- vector(length=0) # nodos por los que se han pasado
contamined <- c(contamined, human_node_start)
# registraremos los nodos que se van contagiendo:
contamined_nodes <- vector("list", length = periods)
number_of_contamined <- matrix(NA, ncol=2, nrow=periods ) # registramos numero de nodos contaminados en cada tiempo
number_of_contamined <- as.data.frame(number_of_contamined)
colnames(number_of_contamined) <- c("time", "infected")
V(g)$contamined[human_node_start] <- 1
tested <- c(tested, human_node_start)
nodes_to_test <- human_node_start
for (t in 1:periods) {
  #vemos los nodos adyacentes
  ady_nodes <- adjacent_vertices(g, nodes_to_test)  
  ady_nodes <- as.numeric(unlist(ady_nodes))
  # vemos si algunos de los nodos adyacentes ya estan contaminados, en ese caso, los sacamos 
  id_drop <- which(V(g)$contamined[ady_nodes] == 1)
  if ( !vector.is.empty(id_drop) ) {
    ady_nodes <- ady_nodes[-id_drop]
  }
  # vemos si algunos de los nodos adyacentes ya habian sido testeados, en ese caso, los sacamos 
  id_drop <- which( ady_nodes %in% tested )
  if ( !vector.is.empty(id_drop) ) {
    ady_nodes <- ady_nodes[-id_drop]
  }
  # En caso que hayan sido testeados todos los nodos, debemos parar
  if ( vector.is.empty(ady_nodes)  ) {
    print(paste("All the nodes have been tested! Process stopped at it:  ", t))
    break
  }
  
  # contaminacion de nodos
  sel <- (runif(length(ady_nodes)) > 0.5)
  sel <- 1*sel
  id <- which(sel == 1)
  recently_contamined <- ady_nodes[id]
  # En el caso que ningun nodo se contamine, el proceso se detiene!!
  if ( vector.is.empty(recently_contamined)  ) {
    print(paste("There were no more transfers! Process stopped at it:  ", t))
    break
  }
  contamined <- c(contamined, recently_contamined) # se registran los nuevos nodos contaminados
  contamined_nodes[[t]] <- recently_contamined
  
  # para el siguiente ciclo.
  tested <- c(tested, ady_nodes) # se registran los nodos que ya han sido testeados
  nodes_to_test <- recently_contamined
  V(g)$contamined[recently_contamined] <- 1
  number_of_contamined[t, ] <- c(t, length(recently_contamined))
}
number_of_contamined 
number_of_contamined$acum <- cumsum(number_of_contamined$infected)
plot(number_of_contamined$time, number_of_contamined$acum, type="l", 
     col="red", lwd=2, main="Infected humans", xlab="Time", ylab="Nodes")
# # # # # # # # # # # # # # # # # # 3. simulate a message transfer to neighborhoods with probability p

